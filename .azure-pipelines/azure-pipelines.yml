name: $(SourceBranchName)-$(Date:yyyyMMdd)$(Rev:.rrr)
trigger:
  batch: false
  tags:
    include:
      - '*'
  branches:
    include:
      - 'master'
  
pool:
  vmImage: 'ubuntu-18.04'

steps:
  - checkout: self
    clean: true
    fetchDepth: 1
  - script: npm install
    env:
        NPMTOKEN: $(NPMTOKEN)
    displayName: Install node modules
  - script: npm run lint
    env:
        NPMTOKEN: $(NPMTOKEN)
    displayName: Lint files
  - script: npm run unit
    env:
        NPMTOKEN: $(NPMTOKEN)
    displayName: Run unit tests
  - script: npm run integration
    env:
        NPMTOKEN: $(NPMTOKEN)
    displayName: Run integration tests
  - script: ./.azure-pipelines/scripts/version-bump-to-release.sh
    condition: and(contains(variables['build.sourceBranch'], 'refs/tags'), succeeded())
    env:
        TAG: $(Build.SourceBranchName)
        GHTOKEN: $(GHTOKEN)
        GHUSER: $(GHUSER)
        GHEMAIL: $(GHEMAIL)
    displayName: Check package.json version matches release and bump
  - script: npm publish
    condition: and(contains(variables['build.sourceBranch'], 'refs/tags'), succeeded())
    env:
        NPMTOKEN: $(NPMTOKEN)
    displayName: Publish to NPM
  - script: ./.azure-pipelines/scripts/version-bump-post-release.sh
    condition: and(contains(variables['build.sourceBranch'], 'refs/tags'), succeeded())
    env:
        GHUSER: $(GHUSER)
        GHEMAIL: $(GHEMAIL)
    displayName: Check package.json version matches release and bump
